<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مختبرات قسم الفيزياء</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/spareparts.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
</head>
<body>
    <div id="dashboard-screen">
        <!-- القائمة الجانبية -->
        <div class="sidebar" style="width: 250px;">
            <div class="d-flex justify-content-center align-items-center py-4">
                <i class="fas fa-atom fa-2x me-2"></i>
                <h4 class="mb-0">مختبرات الفيزياء</h4>
            </div>
            <hr class="bg-light">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="devices.html" data-page="devices">
                        <i class="fas fa-microscope"></i>
                        <span>الأجهزة والمعدات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="labs.html" data-page="labs">
                        <i class="fas fa-flask"></i>
                        <span>المعامل</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="experiments.html" data-page="experiments">
                        <i class="fas fa-vial"></i>
                        <span>التجارب</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="reservations.html" data-page="reservations">
                        <i class="fas fa-calendar-alt"></i>
                        <span>الحجوزات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="spareparts.html" data-page="spareparts">
                        <i class="fas fa-cogs"></i>
                        <span>قطع الغيار</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="maintenance.html" data-page="maintenance">
                        <i class="fas fa-tools"></i>
                        <span>الصيانة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="reports.html" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="users.html" data-page="users">
                        <i class="fas fa-users"></i>
                        <span>المستخدمين</span>
                    </a>
                </li>
            </ul>
            <div class="mt-auto p-3">
                <button id="logout-btn" class="btn btn-outline-light w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج
                </button>
            </div>
        </div>

   <div class="main-content p-4 ms-auto" style="width: calc(100% - 250px);">
            <!-- حاوية التنبيهات -->
            <div id="alerts-container"></div>

            <div id="spareparts-page" class="page-content">
               <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>إدارة قطع الغيار</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSparePartModal">
        <i class="fas fa-plus me-1"></i>إضافة قطعة غيار
    </button>
</div>

<!-- زر عرض الكل -->


 <div class="card">
        <div class="table-container">
<div style="width: 100%; margin-bottom: 10px; text-align: left;">
 <a href="spareparts_all.html" target="_blank" style="
    background-color: #3f51b5;
    color: white;
    padding: 8px 14px;
    border-radius: 5px;
    font-size: 15px;
    text-decoration: none;
    display: inline-block;
    cursor: pointer;
  ">
    عرض الكل
  </a>
</div>      <table>
                <thead>
                    <tr>
                        <th>المعرف</th>
                        <th>اسم القطعة</th>
                        <th>الوصف</th>
                        <th>الكمية</th>
                        <th>الموقع</th>
                        <th>النوع</th>
                        <th>الوحدة</th>
                        <th>التكلفة</th>
                        <th>الجهاز المرتبط</th>
                        <th>الإجراءات</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="spareparts-table-body">
                    <!-- سيتم ملؤه ديناميكياً -->
                </tbody>
            </table>
        </div>
    </div>
</div>
    <!-- نافذة إضافة قطع غيار -->
    <div class="modal fade" id="addSparePartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة قطعة غيار</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <form id="addSparePartForm">
                        <div class="mb-3">
                            <label class="form-label">اسم القطعة</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <input type="text" class="form-control" name="description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">النوع</label>
                            <input type="text" class="form-control" name="type" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الكمية</label>
                            <input type="number" class="form-control" name="quantity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوحدة</label>
                            <input type="text" class="form-control" name="unit" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">التكلفة</label>
                            <input type="number" class="form-control" name="cost" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">معرف المعمل</label>
                            <input type="number" class="form-control" name="laboratoryId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">معرف الجهاز</label>
                            <input type="number" class="form-control" name="deviceId" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل قطع غيار -->
    <div class="modal fade" id="editSparePartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل قطعة غيار</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <form id="editSparePartForm">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">اسم القطعة</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <input type="text" class="form-control" name="description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">النوع</label>
                            <input type="text" class="form-control" name="type" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الكمية</label>
                            <input type="number" class="form-control" name="quantity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوحدة</label>
                            <input type="text" class="form-control" name="unit" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">التكلفة</label>
                            <input type="number" class="form-control" name="cost" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الموقع</label>
                            <input type="text" class="form-control" name="location" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">اسم الجهاز</label>
                            <input type="text" class="form-control" name="deviceName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="updateSparePart">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tbody = document.getElementById("spareparts-table-body");
    let allParts = [];

    // جلب البيانات من الخادم
    fetch("http://labmangmentsystemapi.runasp.net/api/SpareParts")
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            allParts = data.slice(0, 6);
            renderTable(allParts);
        })
        .catch(error => {
            console.error("❌ خطأ أثناء جلب بيانات قطع الغيار:", error);
            tbody.innerHTML = `<tr><td colspan="11" class="text-danger text-center">فشل في تحميل البيانات من الخادم.</td></tr>`;
        });
//Edit
    // دالة لتحميل بيانات القطعة في نموذج التعديل
    function loadPartDataToEditForm(part) {
        const form = document.getElementById("editSparePartForm");
        form.querySelector('[name="id"]').value = part.id;
        form.querySelector('[name="name"]').value = part.name;
        form.querySelector('[name="description"]').value = part.description || '';
        form.querySelector('[name="type"]').value = part.type;
        form.querySelector('[name="quantity"]').value = part.quantity;
        form.querySelector('[name="unit"]').value = part.unit;
        form.querySelector('[name="cost"]').value = part.cost;
        form.querySelector('[name="location"]').value = part.location || '';
        form.querySelector('[name="deviceName"]').value = part.deviceName || '';
    }

    // معالجة حدث الضغط على زر التعديل
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-custom-edit')) {
            const row = e.target.closest('tr');
            const id = parseInt(row.querySelector('td:first-child').textContent);
            const part = allParts.find(p => p.id === id);
            if (part) {
                loadPartDataToEditForm(part);
                const editModal = new bootstrap.Modal(document.getElementById('editSparePartModal'));
                editModal.show();
            }
        }
    });

    // معالجة حدث تحديث قطعة الغيار
    document.getElementById('updateSparePart').addEventListener('click', function() {
        const form = document.getElementById("editSparePartForm");
        const formData = new FormData(form);
        
        const updatedPart = {
            id: parseInt(formData.get("id")),
            name: formData.get("name"),
            description: formData.get("description"),
            type: formData.get("type"),
            quantity: parseInt(formData.get("quantity")),
            unit: formData.get("unit"),
            cost: parseFloat(formData.get("cost")),
            location: formData.get("location"),
            deviceName: formData.get("deviceName")
        };

        // تحديث البيانات على الخادم
        fetch(`http://labmangmentsystemapi.runasp.net/api/SpareParts/${updatedPart.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedPart)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('فشل في تحديث البيانات');
            }
            // تحديث البيانات محلياً
            const index = allParts.findIndex(p => p.id === updatedPart.id);
            if (index !== -1) {
                allParts[index] = updatedPart;
                renderTable(allParts);
            }
            
            // إغلاق المودال وعرض رسالة نجاح
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSparePartModal'));
            modal.hide();
            alert('تم تحديث قطعة الغيار بنجاح');
        })
        .catch(error => {
            console.error('خطأ:', error);
            alert('حدث خطأ أثناء تحديث قطعة الغيار');
        });
    });
//End Edit
    // عند الضغط على زر حفظ في المودال
    const saveBtn = document.querySelector("#addSparePartModal .btn-primary");
    saveBtn.addEventListener("click", () => {
        const form = document.getElementById("addSparePartForm");
        const formData = new FormData(form);
        
        const newPart = {
            id: allParts.length + 1, // توليد معرف جديد
            name: formData.get("name"),
            description: formData.get("description"),
            quantity: parseInt(formData.get("quantity")),
            laboratoryId: parseInt(formData.get("laboratoryId")),
            type: formData.get("type"),
            unit: formData.get("unit"),
            cost: parseFloat(formData.get("cost")),
            deviceId: parseInt(formData.get("deviceId")),
            location: "خزانة الإلكترونيات", // قيمة افتراضية
            deviceName: "مولد الإشارات" // قيمة افتراضية
        };

        // إضافة القطعة الجديدة إلى المصفوفة في النهاية
        allParts.push(newPart);
        renderTable(allParts);
        
        // إعادة تعيين النموذج
        form.reset();
        
        // إغلاق المودال
        const modal = bootstrap.Modal.getInstance(document.getElementById("addSparePartModal"));
        modal.hide();
        
        // عرض رسالة نجاح
        alert("تمت إضافة قطعة الغيار بنجاح");
    });

    function renderTable(parts) {
        tbody.innerHTML = "";
        // عرض القطع بالترتيب الأصلي
        parts.forEach(part => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${part.id}</td>
                <td>${part.name}</td>
                <td>${part.description ?? '-'}</td>
                <td>${part.quantity}</td>
                <td>${part.location ?? '-'}</td>
                <td>${part.type}</td>
                <td>${part.unit}</td>
                <td>${part.cost}</td>
                <td>${part.deviceName ?? '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-custom-edit">تعديل</button>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="confirmDelete(${part.id})">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
});

// دالة تأكيد الحذف
function confirmDelete(id) {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: "لن تتمكن من التراجع عن هذا الإجراء!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذف!',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            deletePart(id);
        }
    });
}

// دالة حذف قطعة الغيار
function deletePart(id) {
    fetch(`http://labmangmentsystemapi.runasp.net/api/SpareParts/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('فشل في حذف القطعة');
        }
        Swal.fire({
            title: 'تم الحذف!',
            text: 'تم حذف قطعة الغيار بنجاح.',
            icon: 'success',
            confirmButtonText: 'حسناً'
        }).then(() => {
            location.reload();
        });
    })
    .catch(error => {
        console.error('خطأ:', error);
        Swal.fire({
            title: 'خطأ!',
            text: 'حدث خطأ أثناء حذف قطعة الغيار.',
            icon: 'error',
            confirmButtonText: 'حسناً'
        });
    });
}
</script>




    <script src="js/logout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
</body>
</html>