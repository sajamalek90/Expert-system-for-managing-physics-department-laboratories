<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مختبرات الفيزياء</title>
  <link rel="stylesheet" href="./css/dashboard.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
</head>
<body>

  <div class="sidebar">
    <div class="top">
      <h2><i class="fas fa-atom"></i> مختبرات الفيزياء</h2>
    </div>
  
    <div class="divider"></div>
  
    <ul class="menu">
      <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
      <li><a href="devices.html" ><i class="fas fa-microscope"></i> الأجهزة والمعدات</a></li>
      <li><a href="reservations.html"><i class="fas fa-calendar-alt"></i> الحجوزات</a></li>
      <li><a href="maintenance.html"><i class="fas fa-tools"></i> الصيانة</a></li>
      <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
      <li><a href="users.html"><i class="fas fa-users"></i> المستخدمين</a></li>
      <li><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
    </ul>
  
    <div class="logout">
      <a href="#"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
    </div>
  </div>
  
<div style="background-color: white; margin:5px; margin-right:30px; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; margin-right: 250px; direction: rtl; margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 5px;">
        <input type="text" id="deviceSearch" placeholder="...بحث عن جهاز بالاسم" style="padding: 8px 8px; border-radius: 20px; border: 1px solid #ccc; width: 300px; margin-top: 10px;">
        <button onclick="searchDeviceByName()" style="background-color: #3f51b5; color: white; border: none; border-radius: 20px; padding: 8px 20px; cursor: pointer; margin-top: 10px;">
          <i class="fas fa-search"></i> بحث
        </button>
      </div>
      
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="margin-right: 39px;">صورة المستخدم</span>
        <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="صورة المستخدم" width="30" height="30" style="border-radius: 50%; ">
      </div>
    </div>
  </div>
  
  <!-- Modal for device details -->
  <div id="deviceModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 60%; max-width: 800px; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
      <span onclick="closeModal()" style="position: absolute; left: 20px; top: 10px; font-size: 28px; cursor: pointer; color: #666;">&times;</span>
      <h2 id="deviceName" style="color: #3f51b5; text-align: center; margin-bottom: 30px; font-size: 24px;"></h2>
      <div id="deviceDetails" style="direction: rtl; font-size: 16px; line-height: 1.6;">
        <!-- Device details will be loaded here -->
      </div>
    </div>
  </div>
  
  <div style="margin-right: 250px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; direction: rtl;">
  
    <div style="font-weight: bold; margin-left:-40px ;margin-right:50px ; font-size: 34px;">لوحة التحكم</div>
  
  
    <button id="exportReportsBtn"   style="background-color:  #3f51b5; color: white;margin-left:40px ; border: none; border-radius: 5px; padding: 10px; font-size: 17px; cursor: pointer;">
      <i class="fas fa-file-export"></i> تصدير التقارير
    </button>
  </div>
  
  <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; flex-direction: row-reverse; margin-right: 250px; direction: rtl;">
    <div style="flex: 1 1 120px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; padding: 10px;">
      <i class="fas fa-calendar-check" style="color: #e91e63; font-size: 18px;"></i>
      <h2 style="margin: 5px 0; font-size: 16px;">12</h2>
      <p style="margin: 0; font-size: 13px;">حجوزات اليوم</p>
    </div>
    <div style="flex: 1 1 120px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; padding: 10px;">
      <i class="fas fa-tools" style="color: #ffc107; font-size: 18px;"></i>
      <h2 style="margin: 5px 0; font-size: 16px;">5</h2>
      <p style="margin: 0; font-size: 13px;">قيد الصيانة</p>
    </div>
    <div style="flex: 1 1 120px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; padding: 10px;">
      <i class="fas fa-check-circle" style="color: #4caf50; font-size: 18px;"></i>
      <h2 style="margin: 5px 0; font-size: 16px;">35</h2>
      <p style="margin: 0; font-size: 13px;">أجهزة متاحة</p>
    </div>
    <div style="flex: 1 1 120px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; padding: 10px;">
      <i class="fas fa-microscope" style="color: #3f51b5; font-size: 18px;"></i>
      <h2 style="margin: 5px 0; font-size: 16px;">42</h2>
      <p style="margin: 0; font-size: 13px;">إجمالي الأجهزة</p>
    </div>
  </div>
  
  
  
  <div class="content">
    <div class="card">
        <h3 class="card-header">
            الأجهزة التي تحتاج صيانة
            <a href="maintenance-devices.html" class="view-all">عرض الكل</a>
          </h3>
          
      <div class="card-content">
        <table class="table">
          <thead>
            <tr>
              <th>اسم الجهاز</th>
              <th>آخر صيانة</th>
              <th>ساعات التشغيل</th>
              <th>الأولوية</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>مولد إشعاع</td>
              <td>10-04-2024</td>
              <td>120 ساعة</td>
              <td><span class="label high">عالية</span></td>
              <td><span class="label low">جدولة</span></td>
            </tr>
            <tr>
              <td>مقياس الطيف الضوئي</td>
              <td>15-03-2025</td>
              <td>95 ساعة</td>
              <td><span class="label medium">متوسطة</span></td>
              <td><span class="label low">جدولة</span></td>
            </tr>
            <tr>
              <td>ميكرفون عالي الدقة</td>
              <td>02-01-2025</td>
              <td>150 ساعة</td>
              <td><span class="label medium">متوسطة</span></td>
              <td><span class="label low">جدولة</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>


<div class="card-row">
    <div class="card card-half long-card">
        <h3 class="card-header">
            حجوزات اليوم
            <a href="all-reservations.html" class="view-all">عرض الكل</a>
          </h3>
          
        <div class="card-content">
          <table class="table" id="reservationsTable">
            <thead>
              <tr>
                <th>التاريخ والوقت</th>
                <th>اسم الجهاز</th>
                <th>المستخدم</th>
                <th>المختبر</th>
                <th>الغرض</th>
              </tr>
            </thead>
            <tbody id="reservationsBody">
              <!-- Reservations will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="card card-half">
        <h3>نشاط المختبرات</h3>
        <div class="card-content">
          <div class="progress-bar"><span style="width: 75%; background-color: #2ecc71;">معمل الميكانيكا 75%</span></div>
          <div class="progress-bar"><span style="width: 60%; background-color: #3498db;">معمل الضوء 60%</span></div>
          <div class="progress-bar"><span style="width: 45%; background-color: #f1c40f;">معمل الحرارة 45%</span></div>
          <div class="progress-bar"><span style="width: 90%; background-color: #e74c3c;">معمل الكهرباء 90%</span></div>
          <div class="progress-bar"><span style="width: 30%; background-color: #1abc9c;">مختبر الذرة 30%</span></div>
        </div>
      </div>
      
    </div>

  </div>

</div>

<script>
  // قائمة الأجهزة المعروفة وأرقامها التسلسلية
  const deviceList = {
    "مجهز الكتروني": 5,
    "ميكروسكوب": 2,
    "مقياس الطيف": 3,
    "مولد إشعاع": 4,
    "ميكرفون عالي الدقة": 1,
    "مصدر بلازما منخفض الطاقة": 6,
    "مولد الموجات": 7,
    "محلل الطيف": 8,
    "مقياس الحرارة": 9,
    "مقياس الضغط": 10
  };

  async function searchDeviceByName() {
    const searchInput = document.getElementById('deviceSearch').value.trim();
  
    if (!searchInput) {
      alert('الرجاء إدخال اسم الجهاز للبحث');
      return;
    }
  
    try {
      // جلب كل الأجهزة
      const response = await fetch('http://labmangmentsystemapi.runasp.net/api/Devices/GetAllDevices');
      if (!response.ok) throw new Error('فشل في جلب قائمة الأجهزة');
  
      const allDevices = await response.json();
  
      // البحث عن الجهاز بالاسم
      const foundDevice = allDevices.find(device =>
        device.name && device.name.toLowerCase().includes(searchInput.toLowerCase())
      );
  
      if (!foundDevice) {
        alert('لم يتم العثور على الجهاز');
        return;
      }
  
      // جلب تفاصيل الجهاز بالكامل باستخدام ID
      const detailResponse = await fetch(`http://labmangmentsystemapi.runasp.net/api/Devices/deviceById/${foundDevice.id}`);
      if (!detailResponse.ok) throw new Error('فشل في جلب تفاصيل الجهاز');
  
      const deviceDetails = await detailResponse.json();
  
      // عرض البيانات
      document.getElementById('deviceName').textContent = deviceDetails.name;
      document.getElementById('deviceDetails').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 10px;">
            <p><strong>الرقم التسلسلي:</strong> ${deviceDetails.serialNumber || '-'}</p>
            <p><strong>الحالة:</strong> <span style="color: ${deviceDetails.status === 'متاح' ? '#4caf50' : '#f44336'}">${deviceDetails.status || '-'}</span></p>
            <p><strong>الفئة:</strong> ${deviceDetails.category || '-'}</p>
            <p><strong>الموقع:</strong> ${deviceDetails.location || '-'}</p>
          </div>
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 10px;">
            <p><strong>تاريخ الشراء:</strong> ${deviceDetails.purchaseDate?.split('T')[0] || '-'}</p>
            <p><strong>العمر الافتراضي:</strong> ${deviceDetails.lifespan ? deviceDetails.lifespan + ' سنة' : '-'}</p>
            <p><strong>آخر صيانة:</strong> ${deviceDetails.lastMaintenance?.split('T')[0] || '-'}</p>
            <p><strong>ملاحظات:</strong> ${deviceDetails.notes || '-'}</p>
          </div>
        </div>
        ${deviceDetails.maintenanceHistory?.length > 0 ? `
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 10px;">
            <h3 style="margin-top: 0; color: #3f51b5;">سجل الصيانة:</h3>
            <ul style="list-style: none; padding: 0;">
              ${deviceDetails.maintenanceHistory.map(h => `
                <li style="padding: 10px; border-bottom: 1px solid #ddd;">
                  <strong>التاريخ:</strong> ${h.date?.split('T')[0] || '-'} |
                  <strong>الوصف:</strong> ${h.description || '-'} |
                  <strong>الحالة:</strong> <span style="color: ${h.status === 'مكتملة' ? '#4caf50' : '#ffc107'}">${h.status || '-'}</span>
                </li>`).join('')}
            </ul>
          </div>` : ''
        }
      `;
  
      document.getElementById('deviceModal').style.display = 'block';
  
    } catch (error) {
      console.error('Error:', error);
      alert('حدث خطأ في البحث عن الجهاز. الرجاء التأكد من اسم الجهاز.');
    }
  }
  

  function closeModal() {
    document.getElementById('deviceModal').style.display = 'none';
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('deviceModal');
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }

  // Function to fetch and display reservations
  async function fetchReservations() {
    try {
      const response = await fetch('http://labmangmentsystemapi.runasp.net/api/Reservations/');
      if (!response.ok) {
        throw new Error('فشل في جلب البيانات');
      }
      const reservations = await response.json();
      
      const tableBody = document.getElementById('reservationsBody');
      tableBody.innerHTML = ''; // Clear existing content
      
      if (reservations.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">
              لا توجد حجوزات
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort reservations by date and time
      reservations.sort((a, b) => {
        if (a.date !== b.date) {
          return a.date.localeCompare(b.date);
        }
        return a.startTime.localeCompare(b.startTime);
      });
      
      // Display first 5 reservations
      const firstFiveReservations = reservations.slice(0, 5);
      displayReservations(firstFiveReservations);
      
      // Update the count in the dashboard card
      const countElement = document.querySelector('.fa-calendar-check').nextElementSibling;
      if (countElement) {
        countElement.textContent = reservations.length;
      }
      
    } catch (error) {
      console.error('Error fetching reservations:', error);
      document.getElementById('reservationsBody').innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; color: red;">
            حدث خطأ في تحميل الحجوزات: ${error.message}
          </td>
        </tr>
      `;
    }
  }

  // Function to display reservations
  function displayReservations(reservationsToShow) {
    const tableBody = document.getElementById('reservationsBody');
    tableBody.innerHTML = ''; // Clear existing content
    
    reservationsToShow.forEach(reservation => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${reservation.date} ${reservation.startTime} - ${reservation.endTime}</td>
        <td>${reservation.deviceName}</td>
        <td>${reservation.userName}</td>
        <td>${reservation.labName}</td>
        <td>${reservation.purpose || '-'}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  // دالة لجلب الأجهزة التي تحتاج صيانة
  async function fetchMaintenanceDevices(showAll = false) {
    try {
      const response = await fetch('https://phy-lab-3-production.up.railway.app/devices/maintenance/needed');
      if (!response.ok) {
        throw new Error('فشل في جلب البيانات');
      }
      const data = await response.json();
      
      // تحديد الجدول الصحيح باستخدام ID
      const tableBody = document.querySelector('.card-content .table tbody');
      if (!tableBody) {
        console.error('لم يتم العثور على الجدول');
        return;
      }
      
      tableBody.innerHTML = ''; // مسح المحتوى الحالي
      
      // التحقق من وجود البيانات
      if (!data || !data.maintenance_list || !Array.isArray(data.maintenance_list)) {
        console.error('البيانات غير صالحة:', data);
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">
              لا توجد أجهزة تحتاج صيانة
            </td>
          </tr>
        `;
        return;
      }
      
      let devices = data.maintenance_list;
      
      // إذا لم يكن عرض الكل، نعرض فقط 5 أجهزة مع 2 طارئة
      if (!showAll) {
        const urgentDevices = devices.filter(d => d.priority === 'طارئة').slice(0, 2);
        const otherDevices = devices.filter(d => d.priority !== 'طارئة').slice(0, 3);
        devices = [...urgentDevices, ...otherDevices];
      }
      
      if (devices.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">
              لا توجد أجهزة تحتاج صيانة
            </td>
          </tr>
        `;
        return;
      }
      
      // عرض الأجهزة في الجدول
      devices.forEach(device => {
        const row = document.createElement('tr');
        const priorityClass = device.priority === 'طارئة' ? 'high' : 
                            device.priority === 'عالية' ? 'medium' : 'low';
        const priorityColor = device.priority === 'طارئة' ? 'red' : 
                            device.priority === 'عالية' ? 'orange' : '#94940c';
        
        row.innerHTML = `
          <td>${device.device_name}</td>
          <td>${device.maintenance_date}</td>
          <td>${device.current_hours} ساعة</td>
          <td><span class="label ${priorityClass}" style="background-color: ${priorityColor}">${device.priority}</span></td>
          <td><span class="label low" style="background-color: #3f51b5">جدولة</span></td>
        `;
        tableBody.appendChild(row);
      });
      
    } catch (error) {
      console.error('Error fetching maintenance devices:', error);
      const tableBody = document.querySelector('.card-content .table tbody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: red;">
              حدث خطأ في تحميل الأجهزة: ${error.message}
            </td>
          </tr>
        `;
      }
    }
  }

  // تحميل الأجهزة التي تحتاج صيانة عند تحميل الصفحة
  window.onload = function() {
    console.log('جاري تحميل الصفحة...');
    fetchMaintenanceDevices();
    fetchReservations();
  };
  
  document.getElementById('exportReportsBtn').addEventListener('click', () => {
    const table = document.getElementById('reservationsTable');
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "الحجوزات");
    XLSX.writeFile(wb, "تقرير_الحجوزات.xlsx");
  });
</script>
</body>
</html>